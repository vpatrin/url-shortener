<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>URL Shortener</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #0f0f0f; color: #e0e0e0;
    min-height: 100vh; display: flex; justify-content: center; padding: 3rem 1rem;
  }
  .container { max-width: 520px; width: 100%; }
  h1 { font-size: 1.5rem; margin-bottom: 2rem; color: #fff; }
  h1 span { color: #888; font-weight: 400; }

  /* Form */
  .card {
    background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 10px;
    padding: 1.5rem; margin-bottom: 1rem;
  }
  label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.05em; }
  input {
    width: 100%; padding: 0.65rem 0.8rem; background: #0f0f0f; border: 1px solid #333;
    border-radius: 6px; color: #e0e0e0; font-size: 0.95rem; outline: none;
    transition: border-color 0.15s;
  }
  input:focus { border-color: #555; }
  input::placeholder { color: #555; }
  .row { display: flex; gap: 0.75rem; margin-top: 0.75rem; }
  .row .field { flex: 1; }
  .row .field-sm { width: 100px; flex: none; }
  button {
    width: 100%; padding: 0.7rem; background: #fff; color: #000; border: none;
    border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer;
    margin-top: 1rem; transition: opacity 0.15s;
  }
  button:hover { opacity: 0.85; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Result */
  .result { display: none; }
  .result.show { display: block; }
  .short-url {
    display: block; padding: 0.65rem 0.8rem; background: #0f0f0f; border: 1px solid #2a2a2a;
    border-radius: 6px; color: #7dd3fc; text-decoration: none; font-size: 0.95rem;
    word-break: break-all;
  }
  .short-url:hover { color: #bae6fd; }
  .meta { font-size: 0.78rem; color: #666; margin-top: 0.5rem; }
  .copy-btn {
    width: auto; display: inline-block; padding: 0.35rem 0.8rem;
    font-size: 0.78rem; margin-top: 0.5rem; background: #2a2a2a; color: #ccc;
  }

  /* Stats */
  .stats-section { margin-top: 2rem; }
  .stats-form { display: flex; gap: 0.5rem; }
  .stats-form input { flex: 1; }
  .stats-form button { width: auto; margin-top: 0; padding: 0.65rem 1.2rem; }
  .stats { display: none; margin-top: 1rem; }
  .stats.show { display: block; }
  .stat-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #222; font-size: 0.85rem; }
  .stat-label { color: #888; }
  table { width: 100%; border-collapse: collapse; margin-top: 0.75rem; font-size: 0.78rem; }
  th { text-align: left; color: #888; padding: 0.4rem 0.5rem; border-bottom: 1px solid #333; font-weight: 500; }
  td { padding: 0.4rem 0.5rem; border-bottom: 1px solid #1a1a1a; color: #aaa; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  .error { color: #f87171; font-size: 0.82rem; margin-top: 0.5rem; display: none; }
  .error.show { display: block; }
</style>
</head>
<body>
<div class="container">
  <h1>s.victorpatrin.dev <span>/ shorten</span></h1>

  <!-- Shorten form -->
  <div class="card">
    <label for="url">URL</label>
    <input type="url" id="url" placeholder="https://example.com/very-long-url" required>
    <div class="row">
      <div class="field-sm">
        <label for="ttl">TTL (hours)</label>
        <input type="number" id="ttl" placeholder="24" min="1">
      </div>
      <div class="field" style="display:flex;align-items:end;">
        <button id="shorten-btn" style="margin-top:0;">Shorten</button>
      </div>
    </div>
    <div class="error" id="shorten-error"></div>
  </div>

  <!-- Result -->
  <div class="card result" id="result">
    <label>Short URL</label>
    <a class="short-url" id="short-url" href="#" target="_blank"></a>
    <div class="meta" id="result-meta"></div>
    <button class="copy-btn" id="copy-btn">Copy</button>
  </div>

  <!-- Stats -->
  <div class="stats-section">
    <div class="card">
      <label>Stats lookup</label>
      <div class="stats-form">
        <input type="text" id="stats-code" placeholder="Code (e.g. aB3xYz)">
        <button id="stats-btn">Go</button>
      </div>
      <div class="error" id="stats-error"></div>
    </div>
    <div class="card stats" id="stats">
      <div class="stat-row"><span class="stat-label">URL</span><span id="s-url"></span></div>
      <div class="stat-row"><span class="stat-label">Clicks</span><span id="s-clicks"></span></div>
      <div class="stat-row"><span class="stat-label">Created</span><span id="s-created"></span></div>
      <div class="stat-row"><span class="stat-label">Expires</span><span id="s-expires"></span></div>
      <table id="clicks-table">
        <thead><tr><th>Time</th><th>IP</th><th>Referer</th></tr></thead>
        <tbody id="clicks-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $ = (s) => document.querySelector(s);

function fmtDate(iso) {
  return new Date(iso).toLocaleString();
}

function showErr(el, msg) {
  el.textContent = msg; el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), 4000);
}

// Shorten
$("#shorten-btn").addEventListener("click", async () => {
  const url = $("#url").value.trim();
  if (!url) return;
  const btn = $("#shorten-btn");
  btn.disabled = true;
  try {
    const body = { url };
    const ttl = parseInt($("#ttl").value);
    if (ttl > 0) body.ttl_hours = ttl;
    const res = await fetch("/shorten", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    if (!res.ok) {
      const d = await res.json();
      throw new Error(d.detail || res.statusText);
    }
    const data = await res.json();
    $("#short-url").href = data.short_url;
    $("#short-url").textContent = data.short_url;
    $("#result-meta").textContent = "Expires " + fmtDate(data.expires_at);
    $("#result").classList.add("show");
  } catch (e) {
    showErr($("#shorten-error"), e.message);
  } finally {
    btn.disabled = false;
  }
});

// Copy
$("#copy-btn").addEventListener("click", () => {
  navigator.clipboard.writeText($("#short-url").href);
  $("#copy-btn").textContent = "Copied!";
  setTimeout(() => ($("#copy-btn").textContent = "Copy"), 1500);
});

// Stats
$("#stats-btn").addEventListener("click", async () => {
  const code = $("#stats-code").value.trim();
  if (!code) return;
  try {
    const res = await fetch("/stats/" + encodeURIComponent(code));
    if (!res.ok) {
      const d = await res.json();
      throw new Error(d.detail || res.statusText);
    }
    const d = await res.json();
    $("#s-url").textContent = d.url;
    $("#s-clicks").textContent = d.click_count;
    $("#s-created").textContent = fmtDate(d.created_at);
    $("#s-expires").textContent = fmtDate(d.expires_at);
    const tbody = $("#clicks-body");
    tbody.innerHTML = "";
    d.clicks.forEach((c) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${fmtDate(c.clicked_at)}</td><td>${c.ip || "-"}</td><td>${c.referer || "-"}</td>`;
      tbody.appendChild(tr);
    });
    $("#stats").classList.add("show");
  } catch (e) {
    $("#stats").classList.remove("show");
    showErr($("#stats-error"), e.message);
  }
});

// Enter key triggers
$("#url").addEventListener("keydown", (e) => { if (e.key === "Enter") $("#shorten-btn").click(); });
$("#stats-code").addEventListener("keydown", (e) => { if (e.key === "Enter") $("#stats-btn").click(); });
</script>
</body>
</html>
